# Alembic Squash Tools Usage Instructions

## Overview

The alembic squash tools automate the process of squashing old Alembic database
migrations in Wazo projects. This is useful for reducing the number of
migration files that are used to setup the database in new deployments, and
limit the maintenance burden of the python scripts.

## Prerequisites and Dependencies

### System Requirements

- **Python 3.9** (for compatibility with bullseye releases)
  - with python venv module (e.g. `python3-venv` on debian distros)
- **Docker** (for building and running database containers)

### Python Dependencies

The tools require the following Python packages(see
[`requirements.txt`](./requirements.txt)):

- `sh>=2.*.*` - Python subprocess interface library
- `migra` - Database schema comparison tool
- `alembic` - Database migration framework

Additionally, the target project's python dependencies are also required.

## Usage Workflow

Assuming a project "wazo-chatd" available at "$LOCAL_GIT_REPOS/wazo-chatd".

### Step 0: Prepare the Squash Plan

Assuming the virtual environment is bootstrapped and a shell with the
environment activated.

```bash
# Navigate to your target project directory
cd $LOCAL_GIT_REPOS/wazo-chatd
export SQUASH_PROJECT_ROOT=$LOCAL_GIT_REPOS/wazo-chatd
```

**Example:**

```bash
$LOCAL_GIT_REPOS/wazo-tools/alembic_squash/alembic_squash.py plan wazo-23.05
```

The command will explain its actions and ask for confirmations.
On success, expect a `.alembic_squash` directory containing a `squashplan`
file.

### Step 1: Generate Baseline Schema Dump

```bash
$LOCAL_GIT_REPOS/wazo-tools/alembic_squash/alembic_squash.py dump-baseline
```

On success, expect a sql dump file to be created in the `.alembic_squash/`
directory.

### Step 2: Execute the Squash

```bash
$LOCAL_GIT_REPOS/wazo-tools/alembic_squash/alembic_squash.py squash
```

Confirmation will be asked on some steps.
The squashed alembic migration will replace the existing revisions.

### Step 3: Verify the Results

```bash
$LOCAL_GIT_REPOS/wazo-tools/alembic_squash/alembic_squash.py verify
```

On success, the output will inform of any discrepancies found between the pre
and post-squashing schemas.
Expect some insignificant differences in the way that some datatypes are
represented(migra will suggest recreating affected constraints).
Make sure no significant differences are found.

Run integration tests(or let the CI do it) to make sure the database is still
working as expected.

## Scripts

### [alembic_squash.py](./alembic_squash.py)

This is a python script orchestrating and performing most of the tasks, calling
out to other tools and scripts.
It is the only script that needs to be used to perform the squash procedure.

See `alembic_squash.py --help` for help on all available commands and options.

### [generate_baseline_schema_dump.sh](./generate_baseline_schema_dump.sh)

This is a bash script taking care of generating a .sql schema dump appropriate
for use in alembic migrations, using a database container built from a database
image specified by a local dockerfile.

- extensions statements are not included
- ownership statements are not included
- the postgres schema `search_path` is left untouched

The script is called by [alembic_squash.py](./alembic_squash.py) to generate
the baseline schema dump when using the `dump-baseline` command(using a
specially-crafted dockerfile running only the alembic migrations to be
squashed)

```bash
# Generate a schema dump manually
~/wazo/wazo-tools/alembic_squash/generate_baseline_schema_dump.sh -f ~/wazo/wazo-example/contribs/docker/Dockerfile-db
```

## Troubleshooting

### Common Issues

1. **"Repo is not clean"** - Commit or stash your changes first
2. **"Git head is on main branch"** - Create a feature branch first
3. **"Dockerfile not found"** - Ensure a `contribs/docker/Dockerfile-db` exists

### Debugging

- Use `--help` flag for command options
- Check the `.alembic_squash/` directory for generated files
- Review diff files generated during verification
- Review sql dump generated by `dump-baseline` command

### Known issues

- `wazo-dird` 23.05: `dird_user_pkey` constraint in pre-squashing schema
  references `xivo_user_uuid` column despite column having been remained to
  `user_uuid`; squashed schema only refers to `user_uuid` column
